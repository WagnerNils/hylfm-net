precision: &precision float
nnum: &nnum 19
z_out: &z_out 49
model:
  name: A02
  kwargs:
    affine_transform_classes:
      361,67,77: Heart_tightCrop_Transform
      361,77,67: Heart_tightCrop_Transform
      361,66,77: Heart_tightCrop_Transform
      361,77,66: Heart_tightCrop_Transform
    interpolation_order: &interpolation_order 2
    n_res2d: [16, 16, u, 8, 8]
    inplanes_3d: 4
    n_res3d: [[4, 2], [1]]
    final_activation: null
    nnum: *nnum
    z_out: *z_out
    input_name: lfc
    prediction_name: pred
    target_name: ls
#  checkpoint: /g/kreshuk/beuttenm/repos/lnet/logs/fish/fdyn1_a02/20-02-21_08-54-55/models/v0_model_4.pth


stages:
- train:
    max_num_epochs: 1

    metrics: &metrics
      MSSSIM: {tensor_names: {y_pred: pred, y: ls}, window_size: 11, size_average: true, val_range: null, normalize: false}
      SSIM: {tensor_names: {y_pred: pred, y: ls}, window_size: 11, window: null, size_average: true, full: false, val_range: null}
      NRMSE: {tensor_names: {y_pred: pred, y: ls}}
      PSNR: {tensor_names: {y_pred: pred, y: ls}, data_range: null}
      BeadPrecision: {tensor_names: {y_pred: pred, y: ls}, dist_threshold: &beadPR 5.0}
      BeadRecall: {tensor_names: {y_pred: pred, y: ls}, dist_threshold: *beadPR}
      SmoothL1Loss: {tensor_names: {y_pred: pred, y: ls}}
      MSELoss: {tensor_names: {y_pred: pred, y: ls}}

    log:
      save_n_checkpoints: 2
      log_scalars_period: {value: 1, unit: iteration}
      log_images_period: {value: 1, unit: epoch}
      input: lf
      prediction: pred
      target: ls
      voxel_losses: []

    validate:
      metrics: *metrics
      log: &eval_log
        log_scalars_period: {value: 1, unit: iteration}
        log_images_period: {value: 1, unit: epoch}
        input: lfc
        prediction: pred
        target: ls
        voxel_losses: []

      score_metric: -SmoothL1Loss
      period: {value: 1, unit: epoch}
      patience: 5
      batch_transforms: &eval_batch_transforms [Cast: {apply_to: [lfc, ls], dtype: *precision, device: cuda}]
      data:
        - batch_size: &eval_batch_size 2
          interpolation_order: *interpolation_order
          sample_transforms: &eval_transforms
            - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
            - Normalize01: {apply_to: ls, min_percentile: 5.0, max_percentile: 99.99}
            - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}

          datasets:
            fish2_20191209_dynamic.t0454c2: {indices: 10535-10537}

    criterion:
      name: WeightedSmoothL1Loss
      kwargs: {threshold: 0.8, initial_weight: .05, apply_below_threshold: true, decay_by: .8, every_nth_epoch: 1}
      tensor_names: {input: pred, target: ls}

    optimizer:
      name: Adam
      kwargs: {lr: 4.0e-4, eps: 1.0e-8}

    sampler:
      base: RandomSampler
      drop_last: false

    batch_transforms:
      - RandomRotate90: {apply_to: [lf, ls]}
      - ChannelFromLightField: {apply_to: {lf: lfc}, nnum: *nnum}
      - Cast: {apply_to: [lfc, ls], dtype: *precision, device: cuda}

    data:
      - batch_size: 2
        interpolation_order: *interpolation_order
        sample_transforms:
          - Normalize01: {apply_to: lf, min_percentile: 5.0, max_percentile: 99.8}
          - Normalize01: {apply_to: ls, min_percentile: 5.0, max_percentile: 99.99}
          - AdditiveGaussianNoise: {apply_to: lf, sigma: 0.1}
          - AdditiveGaussianNoise: {apply_to: ls, sigma: 0.05}
          - RandomIntensityScale: {apply_to: [lf, ls], factor_min: .8, factor_max: 1.2}  # todo: try indep. scaling
          - RandomlyFlipAxis: {apply_to: [lf, ls], axis: -1}
          - RandomlyFlipAxis: {apply_to: [lf, ls], axis: -2}

        datasets:
          fish2_20191209_dynamic.t0454c2: {indices: 30-31}

- test:
    metrics: *metrics
    log: *eval_log
    outputs_to_save: null
    batch_transforms: *eval_batch_transforms
    data:
      - batch_size: *eval_batch_size
        interpolation_order: *interpolation_order
        sample_transforms: *eval_transforms
        datasets:
          fish2_20191209_dynamic.t0454c2: {indices: 10750-10752}